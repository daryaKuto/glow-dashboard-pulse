{
	"info": {
		"_postman_id": "glow-tb-diagnostics-004",
		"name": "Glow ‚Äî ThingsBoard Device Diagnostics",
		"description": "# DryFire Target Diagnostic Collection\n\nReplicates two diagnostic bash scripts for testing ThingsBoard device connectivity and game flow.\n\n## Quick Start\n\n1. Open the **\"0. Setup\"** folder\n2. Run **\"Login to ThingsBoard\"** ‚Äî saves your auth token\n3. Run **\"Discover All Devices & Auto-Select DryFire Targets\"** ‚Äî finds physical targets by name, saves their IDs\n4. Open any other folder ‚Äî all requests use the auto-discovered target IDs\n\n## üìä How to Read Results\n\n**After running any request, click the \"Visualize\" tab** in the response area (next to Body / Cookies / Headers). That's where the formatted, human-readable output appears ‚Äî timestamps, status badges, color-coded tables, etc.\n\nThe raw Body tab always shows ThingsBoard's raw JSON with epoch milliseconds.\n\n## Folder Structure\n\n| Folder | What it does |\n|---|---|\n| **0. Setup** | Login + device discovery |\n| **1. Device Health Check** | MQTT status, telemetry, attributes per target |\n| **2. Game Flow** | Full start ‚Üí play ‚Üí stop lifecycle |\n\n## What are DryFire Targets?\n\nPhysical shooting-practice devices connected to ThingsBoard via MQTT.\n- Name format: `Dryfire-XXXXXXXXXXXX` (hex suffix = MAC address)\n- Device type: `dryfire-provision` (auto-provisioned via BLE app)\n- `active: true` = MQTT connected, can receive RPC commands\n- `active: false` = offline, RPC will hang or return 504\n\n## Troubleshooting\n\n- **RPC returns 504 or hangs forever**: Device is offline. Power-cycle it, wait 60s, re-run MQTT status check.\n- **No DryFire targets found in Step 2**: Devices haven't been provisioned. Use the DryFire provisioning app.\n- **401 Unauthorized**: Token expired. Re-run Login.",
		"schema": "https://schema.getpostman.com/json/collection/v2.1.0/collection.json"
	},
	"auth": {
		"type": "bearer",
		"bearer": [
			{
				"key": "token",
				"value": "{{tb_token}}",
				"type": "string"
			}
		]
	},
	"variable": [
		{
			"key": "tb_url",
			"value": "https://thingsboard.cloud",
			"type": "string",
			"description": "ThingsBoard Cloud base URL"
		},
		{
			"key": "tb_username",
			"value": "andrew.tam@gmail.com",
			"type": "string",
			"description": "ThingsBoard login email"
		},
		{
			"key": "tb_password",
			"value": "dryfire2025",
			"type": "string",
			"description": "ThingsBoard login password"
		},
		{
			"key": "tb_token",
			"value": "",
			"type": "string",
			"description": "AUTO-SET by Login. JWT auth token."
		},
		{
			"key": "target_a_id",
			"value": "",
			"type": "string",
			"description": "AUTO-SET by Discover. UUID of first DryFire target."
		},
		{
			"key": "target_a_name",
			"value": "",
			"type": "string",
			"description": "AUTO-SET by Discover. Name of first DryFire target."
		},
		{
			"key": "target_b_id",
			"value": "",
			"type": "string",
			"description": "AUTO-SET by Discover. UUID of second DryFire target."
		},
		{
			"key": "target_b_name",
			"value": "",
			"type": "string",
			"description": "AUTO-SET by Discover. Name of second DryFire target."
		},
		{
			"key": "game_id",
			"value": "",
			"type": "string",
			"description": "AUTO-SET when starting a game. Unique session ID."
		},
		{
			"key": "game_duration",
			"value": "30",
			"type": "string",
			"description": "Game duration in seconds. Change if you want longer/shorter."
		}
	],
	"item": [
		{
			"name": "0. Setup ‚Äî Login & Discover Devices",
			"description": "# Setup\n\n**Run both requests in this folder first, in order.**\n\n1. **Login** ‚Äî authenticates with ThingsBoard, saves JWT token\n2. **Discover Devices** ‚Äî lists ALL tenant devices, auto-selects the two newest DryFire physical targets\n\nAfter this, every other request in the collection will work automatically.",
			"item": [
				{
					"name": "Login to ThingsBoard",
					"event": [
						{
							"listen": "test",
							"script": {
								"exec": [
									"const json = pm.response.json();",
									"",
									"if (json.token) {",
									"    pm.collectionVariables.set('tb_token', json.token);",
									"    pm.test('‚úÖ Logged in ‚Äî token saved', () => pm.expect(json.token).to.be.a('string'));",
									"",
									"    const template = `<div style=\"font-family:-apple-system,BlinkMacSystemFont,sans-serif;padding:20px;max-width:600px\">",
									"        <h2 style=\"color:#10b981\">‚úÖ Authenticated</h2>",
									"        <table style=\"border-collapse:collapse;width:100%\">",
									"            <tr><td style=\"padding:8px;font-weight:bold;color:#6b7280\">User</td><td style=\"padding:8px\">{{user}}</td></tr>",
									"            <tr style=\"background:#f9fafb\"><td style=\"padding:8px;font-weight:bold;color:#6b7280\">Token</td><td style=\"padding:8px;font-family:monospace;font-size:12px;word-break:break-all\">{{token}}</td></tr>",
									"        </table>",
									"        <p style=\"margin-top:16px;padding:12px;background:#f0fdf4;border-radius:8px;color:#166534\">",
									"            üëâ <strong>NEXT:</strong> Run \"Discover All Devices & Auto-Select DryFire Targets\"",
									"        </p>",
									"    </div>`;",
									"",
									"    pm.visualizer.set(template, {",
									"        user: pm.collectionVariables.get('tb_username'),",
									"        token: json.token.substring(0, 60) + '...'",
									"    });",
									"} else {",
									"    pm.test('‚ùå Login failed', () => pm.expect.fail(JSON.stringify(json)));",
									"",
									"    const template = `<div style=\"font-family:-apple-system,BlinkMacSystemFont,sans-serif;padding:20px\">",
									"        <h2 style=\"color:#ef4444\">‚ùå Login Failed</h2>",
									"        <pre style=\"background:#fef2f2;padding:12px;border-radius:8px;color:#991b1b\">{{error}}</pre>",
									"    </div>`;",
									"    pm.visualizer.set(template, { error: JSON.stringify(json, null, 2) });",
									"}"
								],
								"type": "text/javascript"
							}
						}
					],
					"request": {
						"auth": { "type": "noauth" },
						"method": "POST",
						"header": [
							{ "key": "Content-Type", "value": "application/json" }
						],
						"body": {
							"mode": "raw",
							"raw": "{\n    \"username\": \"{{tb_username}}\",\n    \"password\": \"{{tb_password}}\"\n}"
						},
						"url": {
							"raw": "{{tb_url}}/api/auth/login",
							"host": ["{{tb_url}}"],
							"path": ["api", "auth", "login"]
						},
						"description": "# Login to ThingsBoard\n\n**Run this first.** Authenticates with ThingsBoard Cloud and saves the JWT token.\n\nThe token is automatically used by all other requests in this collection (via the `{{tb_token}}` variable in the Bearer auth header).\n\nCredentials are in the collection variables tab.\n\n## Reading the result\nClick the **Visualize** tab in the response area to see the formatted output."
					}
				},
				{
					"name": "Discover All Devices & Auto-Select DryFire Targets",
					"event": [
						{
							"listen": "test",
							"script": {
								"exec": [
									"const json = pm.response.json();",
									"const allDevices = json.data || [];",
									"",
									"const dryfireTargets = allDevices.filter(d => d.type === 'dryfire-provision');",
									"const otherDevices = allDevices.filter(d => d.type !== 'dryfire-provision');",
									"",
									"// Format date from epoch ms",
									"const fmtDate = (ms) => {",
									"    if (!ms) return '‚Äî';",
									"    const d = new Date(ms);",
									"    const pad = (n) => String(n).padStart(2, '0');",
									"    return d.getFullYear() + '-' + pad(d.getMonth()+1) + '-' + pad(d.getDate()) + ' ' + pad(d.getHours()) + ':' + pad(d.getMinutes());",
									"};",
									"",
									"// Auto-save the two newest DryFire targets",
									"dryfireTargets.sort((a, b) => b.createdTime - a.createdTime);",
									"if (dryfireTargets.length >= 1) {",
									"    pm.collectionVariables.set('target_a_id', dryfireTargets[0].id.id);",
									"    pm.collectionVariables.set('target_a_name', dryfireTargets[0].name);",
									"}",
									"if (dryfireTargets.length >= 2) {",
									"    pm.collectionVariables.set('target_b_id', dryfireTargets[1].id.id);",
									"    pm.collectionVariables.set('target_b_name', dryfireTargets[1].name);",
									"}",
									"",
									"pm.test('Found ' + dryfireTargets.length + ' DryFire target(s), ' + otherDevices.length + ' other device(s)', () => {",
									"    pm.expect(dryfireTargets.length).to.be.greaterThan(0);",
									"});",
									"",
									"// Build visualizer",
									"const template = `",
									"<style>",
									"    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; }",
									"    .container { padding: 20px; max-width: 800px; }",
									"    h2 { margin-bottom: 4px; }",
									"    .subtitle { color: #6b7280; margin-top: 0; margin-bottom: 16px; }",
									"    table { border-collapse: collapse; width: 100%; margin-bottom: 20px; }",
									"    th { text-align: left; padding: 10px 12px; background: #f1f5f9; border-bottom: 2px solid #e2e8f0; font-size: 13px; color: #475569; }",
									"    td { padding: 8px 12px; border-bottom: 1px solid #f1f5f9; font-size: 13px; }",
									"    tr:hover { background: #f8fafc; }",
									"    .mono { font-family: monospace; font-size: 11px; color: #6b7280; }",
									"    .badge { display: inline-block; padding: 2px 8px; border-radius: 12px; font-size: 11px; font-weight: 600; }",
									"    .badge-target { background: #dbeafe; color: #1e40af; }",
									"    .badge-other { background: #f3f4f6; color: #6b7280; }",
									"    .selected { background: #f0fdf4; }",
									"    .selected td { font-weight: 500; }",
									"    .next-step { margin-top: 16px; padding: 12px; background: #f0fdf4; border-radius: 8px; color: #166534; }",
									"    .warn { margin-top: 16px; padding: 12px; background: #fefce8; border-radius: 8px; color: #854d0e; }",
									"</style>",
									"<div class='container'>",
									"    <h2>üìã All Devices ({{totalCount}})</h2>",
									"    <p class='subtitle'>{{dryfireCount}} physical DryFire target(s) + {{otherCount}} other device(s)</p>",
									"",
									"    {{#if hasDryfire}}",
									"    <h3>üéØ Physical DryFire Targets</h3>",
									"    <table>",
									"        <tr><th>#</th><th>Name</th><th>Device ID</th><th>Created</th><th>Auto-Selected</th></tr>",
									"        {{#each dryfire}}",
									"        <tr class='{{#if this.selected}}selected{{/if}}'>",
									"            <td>{{this.idx}}</td>",
									"            <td><strong>{{this.name}}</strong></td>",
									"            <td class='mono'>{{this.id}}</td>",
									"            <td>{{this.created}}</td>",
									"            <td>{{#if this.selected}}<span class='badge badge-target'>{{this.role}}</span>{{/if}}</td>",
									"        </tr>",
									"        {{/each}}",
									"    </table>",
									"    {{/if}}",
									"",
									"    {{#if hasOther}}",
									"    <h3>üß™ Other Devices (test / virtual)</h3>",
									"    <table>",
									"        <tr><th>Name</th><th>Device ID</th><th>Type</th></tr>",
									"        {{#each other}}",
									"        <tr>",
									"            <td>{{this.name}}</td>",
									"            <td class='mono'>{{this.id}}</td>",
									"            <td><span class='badge badge-other'>{{this.type}}</span></td>",
									"        </tr>",
									"        {{/each}}",
									"    </table>",
									"    {{/if}}",
									"",
									"    {{#if hasDryfire}}",
									"    <div class='next-step'>üëâ <strong>NEXT:</strong> Open \"1. Device Health Check\" to see if targets are online</div>",
									"    {{else}}",
									"    <div class='warn'>‚ö†Ô∏è No DryFire targets found. Devices haven't been provisioned yet.</div>",
									"    {{/if}}",
									"</div>`;",
									"",
									"pm.visualizer.set(template, {",
									"    totalCount: allDevices.length,",
									"    dryfireCount: dryfireTargets.length,",
									"    otherCount: otherDevices.length,",
									"    hasDryfire: dryfireTargets.length > 0,",
									"    hasOther: otherDevices.length > 0,",
									"    dryfire: dryfireTargets.map((d, i) => ({",
									"        idx: i + 1,",
									"        name: d.name,",
									"        id: d.id.id,",
									"        created: fmtDate(d.createdTime),",
									"        selected: i < 2,",
									"        role: i === 0 ? 'Target A' : i === 1 ? 'Target B' : ''",
									"    })),",
									"    other: otherDevices.map(d => ({",
									"        name: d.name,",
									"        id: d.id.id,",
									"        type: d.type || 'default'",
									"    }))",
									"});"
								],
								"type": "text/javascript"
							}
						}
					],
					"request": {
						"method": "GET",
						"header": [],
						"url": {
							"raw": "{{tb_url}}/api/tenant/devices?pageSize=100&page=0",
							"host": ["{{tb_url}}"],
							"path": ["api", "tenant", "devices"],
							"query": [
								{ "key": "pageSize", "value": "100" },
								{ "key": "page", "value": "0" }
							]
						},
						"description": "# Discover All Devices\n\n**Run this after Login.** Fetches every device on the tenant and shows them grouped by type.\n\n## What it does\n1. Lists ALL devices ‚Äî both real DryFire targets and test/virtual devices\n2. Shows each device's **name** and **ID** so you can identify them\n3. Auto-selects the two **newest** DryFire targets (type=`dryfire-provision`) and saves them as `target_a` and `target_b`\n\n## How to read the output\nClick the **Visualize** tab in the response area to see a formatted table with device names, IDs, and auto-selection."
					}
				}
			]
		},
		{
			"name": "1. Device Health Check",
			"description": "# Device Health Check\n\nUse these requests to check if your DryFire targets are connected and reporting data.\n\n**Before running a game, both targets must show `active: true`.**\n\nAfter running each request, click the **Visualize** tab to see formatted, human-readable output with timestamps converted to real dates.",
			"item": [
				{
					"name": "Target A ‚Äî Is it online? (MQTT status)",
					"event": [
						{
							"listen": "test",
							"script": {
								"exec": [
									"const json = pm.response.json();",
									"const name = pm.collectionVariables.get('target_a_name') || 'Target A (run Setup first!)';",
									"const id = pm.collectionVariables.get('target_a_id') || '?';",
									"const find = (key) => { const item = json.find(a => a.key === key); return item ? item.value : null; };",
									"",
									"const active = find('active');",
									"const lastConnect = find('lastConnectTime');",
									"const lastActivity = find('lastActivityTime');",
									"const lastDisconnect = find('lastDisconnectTime');",
									"const inactivityAlarm = find('inactivityAlarmTime');",
									"",
									"pm.test(name + ' ‚Üí active = ' + active, () => pm.expect(active).to.not.be.null);",
									"",
									"// Visualizer ‚Äî formatted HTML directly in the response Visualize tab",
									"const template = `",
									"<style>",
									"    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; }",
									"    .container { padding: 20px; max-width: 700px; }",
									"    .device-header { display: flex; align-items: center; gap: 12px; margin-bottom: 4px; }",
									"    .device-header h2 { margin: 0; }",
									"    .device-id { font-family: monospace; font-size: 12px; color: #6b7280; }",
									"    .status-banner { padding: 16px; border-radius: 8px; margin: 16px 0; }",
									"    .status-online { background: #f0fdf4; border: 1px solid #bbf7d0; }",
									"    .status-online h3 { color: #166534; margin: 0 0 4px 0; }",
									"    .status-online p { color: #15803d; margin: 0; }",
									"    .status-offline { background: #fef2f2; border: 1px solid #fecaca; }",
									"    .status-offline h3 { color: #991b1b; margin: 0 0 4px 0; }",
									"    .status-offline p { color: #b91c1c; margin: 0; }",
									"    table { border-collapse: collapse; width: 100%; margin-top: 16px; }",
									"    th { text-align: left; padding: 10px 12px; background: #f1f5f9; border-bottom: 2px solid #e2e8f0; font-size: 13px; color: #475569; }",
									"    td { padding: 8px 12px; border-bottom: 1px solid #f1f5f9; font-size: 13px; }",
									"    .ts-raw { font-family: monospace; font-size: 11px; color: #9ca3af; }",
									"    .ts-human { font-weight: 500; }",
									"    .ts-ago { color: #6b7280; font-size: 12px; }",
									"    .offline-duration { margin-top: 12px; padding: 10px; background: #fefce8; border-radius: 6px; color: #854d0e; font-size: 13px; }",
									"    .fix-tip { margin-top: 12px; padding: 10px; background: #fef2f2; border-radius: 6px; color: #991b1b; font-size: 13px; }",
									"</style>",
									"<div class='container'>",
									"    <div class='device-header'>",
									"        <h2>üéØ {{deviceName}}</h2>",
									"    </div>",
									"    <div class='device-id'>ID: {{deviceId}}</div>",
									"",
									"    {{#if isOnline}}",
									"    <div class='status-banner status-online'>",
									"        <h3>‚úÖ ONLINE</h3>",
									"        <p>Device has an active MQTT session ‚Äî it CAN receive RPC commands (start/stop game)</p>",
									"    </div>",
									"    {{else}}",
									"    <div class='status-banner status-offline'>",
									"        <h3>‚ùå OFFLINE</h3>",
									"        <p>No active MQTT session ‚Äî RPC commands will HANG or return HTTP 504</p>",
									"    </div>",
									"    {{/if}}",
									"",
									"    <table>",
									"        <tr><th>Attribute</th><th>Value</th><th>Human-Readable Time</th><th>How Long Ago</th></tr>",
									"        <tr>",
									"            <td><strong>active</strong></td>",
									"            <td>{{activeValue}}</td>",
									"            <td>‚Äî</td>",
									"            <td>‚Äî</td>",
									"        </tr>",
									"        <tr>",
									"            <td><strong>lastConnectTime</strong></td>",
									"            <td class='ts-raw'>{{lastConnectRaw}}</td>",
									"            <td class='ts-human'>{{lastConnectHuman}}</td>",
									"            <td class='ts-ago'>{{lastConnectAgo}}</td>",
									"        </tr>",
									"        <tr>",
									"            <td><strong>lastActivityTime</strong></td>",
									"            <td class='ts-raw'>{{lastActivityRaw}}</td>",
									"            <td class='ts-human'>{{lastActivityHuman}}</td>",
									"            <td class='ts-ago'>{{lastActivityAgo}}</td>",
									"        </tr>",
									"        <tr>",
									"            <td><strong>lastDisconnectTime</strong></td>",
									"            <td class='ts-raw'>{{lastDisconnectRaw}}</td>",
									"            <td class='ts-human'>{{lastDisconnectHuman}}</td>",
									"            <td class='ts-ago'>{{lastDisconnectAgo}}</td>",
									"        </tr>",
									"        <tr>",
									"            <td><strong>inactivityAlarmTime</strong></td>",
									"            <td class='ts-raw'>{{inactivityRaw}}</td>",
									"            <td class='ts-human'>{{inactivityHuman}}</td>",
									"            <td class='ts-ago'>{{inactivityAgo}}</td>",
									"        </tr>",
									"    </table>",
									"",
									"    {{#if offlineDuration}}",
									"    <div class='offline-duration'>‚è±Ô∏è Offline for approximately <strong>{{offlineDuration}}</strong></div>",
									"    {{/if}}",
									"",
									"    {{#unless isOnline}}",
									"    <div class='fix-tip'>üí° <strong>Fix:</strong> Power-cycle the physical target, wait 60 seconds, then re-run this request.</div>",
									"    {{/unless}}",
									"</div>`;",
									"",
									"// Timestamp formatting helpers",
									"const fmtHuman = (ms) => {",
									"    if (!ms && ms !== 0) return '‚Äî';",
									"    const d = new Date(ms);",
									"    const pad = (n) => String(n).padStart(2, '0');",
									"    return d.getFullYear() + '-' + pad(d.getMonth()+1) + '-' + pad(d.getDate()) + ' ' + pad(d.getHours()) + ':' + pad(d.getMinutes()) + ':' + pad(d.getSeconds());",
									"};",
									"const fmtAgo = (ms) => {",
									"    if (!ms && ms !== 0) return '‚Äî';",
									"    const ago = Math.round((Date.now() - ms) / 1000);",
									"    if (ago < 0) return 'in the future?';",
									"    if (ago < 60) return ago + ' seconds ago';",
									"    if (ago < 3600) return Math.round(ago/60) + ' minutes ago';",
									"    if (ago < 86400) return Math.round(ago/3600) + ' hours ago';",
									"    return Math.round(ago/86400) + ' days ago';",
									"};",
									"const fmtDuration = (ms) => {",
									"    if (!ms) return null;",
									"    const min = Math.round(ms / 60000);",
									"    if (min < 60) return min + ' minutes';",
									"    if (min < 1440) return Math.round(min/60) + ' hours';",
									"    return Math.round(min/1440) + ' days';",
									"};",
									"",
									"let offlineDur = null;",
									"if (lastDisconnect && lastConnect && lastDisconnect > lastConnect) {",
									"    offlineDur = fmtDuration(Date.now() - lastDisconnect);",
									"}",
									"",
									"pm.visualizer.set(template, {",
									"    deviceName: name,",
									"    deviceId: id,",
									"    isOnline: active === true,",
									"    activeValue: String(active),",
									"    lastConnectRaw: lastConnect || '‚Äî',",
									"    lastConnectHuman: fmtHuman(lastConnect),",
									"    lastConnectAgo: fmtAgo(lastConnect),",
									"    lastActivityRaw: lastActivity || '‚Äî',",
									"    lastActivityHuman: fmtHuman(lastActivity),",
									"    lastActivityAgo: fmtAgo(lastActivity),",
									"    lastDisconnectRaw: lastDisconnect || '‚Äî',",
									"    lastDisconnectHuman: fmtHuman(lastDisconnect),",
									"    lastDisconnectAgo: fmtAgo(lastDisconnect),",
									"    inactivityRaw: inactivityAlarm || '‚Äî',",
									"    inactivityHuman: fmtHuman(inactivityAlarm),",
									"    inactivityAgo: fmtAgo(inactivityAlarm),",
									"    offlineDuration: offlineDur",
									"});"
								],
								"type": "text/javascript"
							}
						}
					],
					"request": {
						"method": "GET",
						"header": [],
						"url": {
							"raw": "{{tb_url}}/api/plugins/telemetry/DEVICE/{{target_a_id}}/values/attributes/SERVER_SCOPE?keys=active,lastConnectTime,lastActivityTime,lastDisconnectTime,inactivityAlarmTime",
							"host": ["{{tb_url}}"],
							"path": ["api", "plugins", "telemetry", "DEVICE", "{{target_a_id}}", "values", "attributes", "SERVER_SCOPE"],
							"query": [
								{ "key": "keys", "value": "active,lastConnectTime,lastActivityTime,lastDisconnectTime,inactivityAlarmTime" }
							]
						},
						"description": "# Is Target A online?\n\nChecks the `active` server attribute ‚Äî this is set automatically by ThingsBoard when a device connects/disconnects via MQTT.\n\n| active | Meaning |\n|---|---|\n| `true` | Device connected. Can receive RPC. |\n| `false` | Device disconnected. RPC will fail. |\n\n## Reading the result\nClick the **Visualize** tab to see formatted timestamps and status.\n\n## If offline\n1. Power-cycle the physical target\n2. Wait 60 seconds for MQTT reconnect\n3. Re-run this request ‚Äî should show `active: true`"
					}
				},
				{
					"name": "Target B ‚Äî Is it online? (MQTT status)",
					"event": [
						{
							"listen": "test",
							"script": {
								"exec": [
									"const json = pm.response.json();",
									"const name = pm.collectionVariables.get('target_b_name') || 'Target B (run Setup first!)';",
									"const id = pm.collectionVariables.get('target_b_id') || '?';",
									"const find = (key) => { const item = json.find(a => a.key === key); return item ? item.value : null; };",
									"",
									"const active = find('active');",
									"const lastConnect = find('lastConnectTime');",
									"const lastActivity = find('lastActivityTime');",
									"const lastDisconnect = find('lastDisconnectTime');",
									"const inactivityAlarm = find('inactivityAlarmTime');",
									"",
									"pm.test(name + ' ‚Üí active = ' + active, () => pm.expect(active).to.not.be.null);",
									"",
									"const template = `",
									"<style>",
									"    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; }",
									"    .container { padding: 20px; max-width: 700px; }",
									"    .device-header { display: flex; align-items: center; gap: 12px; margin-bottom: 4px; }",
									"    .device-header h2 { margin: 0; }",
									"    .device-id { font-family: monospace; font-size: 12px; color: #6b7280; }",
									"    .status-banner { padding: 16px; border-radius: 8px; margin: 16px 0; }",
									"    .status-online { background: #f0fdf4; border: 1px solid #bbf7d0; }",
									"    .status-online h3 { color: #166534; margin: 0 0 4px 0; }",
									"    .status-online p { color: #15803d; margin: 0; }",
									"    .status-offline { background: #fef2f2; border: 1px solid #fecaca; }",
									"    .status-offline h3 { color: #991b1b; margin: 0 0 4px 0; }",
									"    .status-offline p { color: #b91c1c; margin: 0; }",
									"    table { border-collapse: collapse; width: 100%; margin-top: 16px; }",
									"    th { text-align: left; padding: 10px 12px; background: #f1f5f9; border-bottom: 2px solid #e2e8f0; font-size: 13px; color: #475569; }",
									"    td { padding: 8px 12px; border-bottom: 1px solid #f1f5f9; font-size: 13px; }",
									"    .ts-raw { font-family: monospace; font-size: 11px; color: #9ca3af; }",
									"    .ts-human { font-weight: 500; }",
									"    .ts-ago { color: #6b7280; font-size: 12px; }",
									"    .offline-duration { margin-top: 12px; padding: 10px; background: #fefce8; border-radius: 6px; color: #854d0e; font-size: 13px; }",
									"    .fix-tip { margin-top: 12px; padding: 10px; background: #fef2f2; border-radius: 6px; color: #991b1b; font-size: 13px; }",
									"</style>",
									"<div class='container'>",
									"    <div class='device-header'>",
									"        <h2>üéØ {{deviceName}}</h2>",
									"    </div>",
									"    <div class='device-id'>ID: {{deviceId}}</div>",
									"",
									"    {{#if isOnline}}",
									"    <div class='status-banner status-online'>",
									"        <h3>‚úÖ ONLINE</h3>",
									"        <p>Device has an active MQTT session ‚Äî it CAN receive RPC commands</p>",
									"    </div>",
									"    {{else}}",
									"    <div class='status-banner status-offline'>",
									"        <h3>‚ùå OFFLINE</h3>",
									"        <p>No active MQTT session ‚Äî RPC commands will HANG or return HTTP 504</p>",
									"    </div>",
									"    {{/if}}",
									"",
									"    <table>",
									"        <tr><th>Attribute</th><th>Value</th><th>Human-Readable Time</th><th>How Long Ago</th></tr>",
									"        <tr>",
									"            <td><strong>active</strong></td>",
									"            <td>{{activeValue}}</td>",
									"            <td>‚Äî</td>",
									"            <td>‚Äî</td>",
									"        </tr>",
									"        <tr>",
									"            <td><strong>lastConnectTime</strong></td>",
									"            <td class='ts-raw'>{{lastConnectRaw}}</td>",
									"            <td class='ts-human'>{{lastConnectHuman}}</td>",
									"            <td class='ts-ago'>{{lastConnectAgo}}</td>",
									"        </tr>",
									"        <tr>",
									"            <td><strong>lastActivityTime</strong></td>",
									"            <td class='ts-raw'>{{lastActivityRaw}}</td>",
									"            <td class='ts-human'>{{lastActivityHuman}}</td>",
									"            <td class='ts-ago'>{{lastActivityAgo}}</td>",
									"        </tr>",
									"        <tr>",
									"            <td><strong>lastDisconnectTime</strong></td>",
									"            <td class='ts-raw'>{{lastDisconnectRaw}}</td>",
									"            <td class='ts-human'>{{lastDisconnectHuman}}</td>",
									"            <td class='ts-ago'>{{lastDisconnectAgo}}</td>",
									"        </tr>",
									"        <tr>",
									"            <td><strong>inactivityAlarmTime</strong></td>",
									"            <td class='ts-raw'>{{inactivityRaw}}</td>",
									"            <td class='ts-human'>{{inactivityHuman}}</td>",
									"            <td class='ts-ago'>{{inactivityAgo}}</td>",
									"        </tr>",
									"    </table>",
									"",
									"    {{#if offlineDuration}}",
									"    <div class='offline-duration'>‚è±Ô∏è Offline for approximately <strong>{{offlineDuration}}</strong></div>",
									"    {{/if}}",
									"",
									"    {{#unless isOnline}}",
									"    <div class='fix-tip'>üí° <strong>Fix:</strong> Power-cycle the physical target, wait 60 seconds, then re-run this request.</div>",
									"    {{/unless}}",
									"</div>`;",
									"",
									"const fmtHuman = (ms) => {",
									"    if (!ms && ms !== 0) return '‚Äî';",
									"    const d = new Date(ms);",
									"    const pad = (n) => String(n).padStart(2, '0');",
									"    return d.getFullYear() + '-' + pad(d.getMonth()+1) + '-' + pad(d.getDate()) + ' ' + pad(d.getHours()) + ':' + pad(d.getMinutes()) + ':' + pad(d.getSeconds());",
									"};",
									"const fmtAgo = (ms) => {",
									"    if (!ms && ms !== 0) return '‚Äî';",
									"    const ago = Math.round((Date.now() - ms) / 1000);",
									"    if (ago < 0) return 'in the future?';",
									"    if (ago < 60) return ago + ' seconds ago';",
									"    if (ago < 3600) return Math.round(ago/60) + ' minutes ago';",
									"    if (ago < 86400) return Math.round(ago/3600) + ' hours ago';",
									"    return Math.round(ago/86400) + ' days ago';",
									"};",
									"const fmtDuration = (ms) => {",
									"    if (!ms) return null;",
									"    const min = Math.round(ms / 60000);",
									"    if (min < 60) return min + ' minutes';",
									"    if (min < 1440) return Math.round(min/60) + ' hours';",
									"    return Math.round(min/1440) + ' days';",
									"};",
									"",
									"let offlineDur = null;",
									"if (lastDisconnect && lastConnect && lastDisconnect > lastConnect) {",
									"    offlineDur = fmtDuration(Date.now() - lastDisconnect);",
									"}",
									"",
									"pm.visualizer.set(template, {",
									"    deviceName: name,",
									"    deviceId: id,",
									"    isOnline: active === true,",
									"    activeValue: String(active),",
									"    lastConnectRaw: lastConnect || '‚Äî',",
									"    lastConnectHuman: fmtHuman(lastConnect),",
									"    lastConnectAgo: fmtAgo(lastConnect),",
									"    lastActivityRaw: lastActivity || '‚Äî',",
									"    lastActivityHuman: fmtHuman(lastActivity),",
									"    lastActivityAgo: fmtAgo(lastActivity),",
									"    lastDisconnectRaw: lastDisconnect || '‚Äî',",
									"    lastDisconnectHuman: fmtHuman(lastDisconnect),",
									"    lastDisconnectAgo: fmtAgo(lastDisconnect),",
									"    inactivityRaw: inactivityAlarm || '‚Äî',",
									"    inactivityHuman: fmtHuman(inactivityAlarm),",
									"    inactivityAgo: fmtAgo(inactivityAlarm),",
									"    offlineDuration: offlineDur",
									"});"
								],
								"type": "text/javascript"
							}
						}
					],
					"request": {
						"method": "GET",
						"header": [],
						"url": {
							"raw": "{{tb_url}}/api/plugins/telemetry/DEVICE/{{target_b_id}}/values/attributes/SERVER_SCOPE?keys=active,lastConnectTime,lastActivityTime,lastDisconnectTime,inactivityAlarmTime",
							"host": ["{{tb_url}}"],
							"path": ["api", "plugins", "telemetry", "DEVICE", "{{target_b_id}}", "values", "attributes", "SERVER_SCOPE"],
							"query": [
								{ "key": "keys", "value": "active,lastConnectTime,lastActivityTime,lastDisconnectTime,inactivityAlarmTime" }
							]
						},
						"description": "# Is Target B online?\n\nSame check as Target A. Click **Visualize** tab for formatted output."
					}
				},
				{
					"name": "Target A ‚Äî What is it reporting? (Telemetry)",
					"event": [
						{
							"listen": "test",
							"script": {
								"exec": [
									"const json = pm.response.json();",
									"const name = pm.collectionVariables.get('target_a_name') || 'Target A';",
									"const id = pm.collectionVariables.get('target_a_id') || '?';",
									"const keys = Object.keys(json);",
									"",
									"pm.test(name + ': ' + keys.length + ' telemetry keys', () => pm.expect(keys.length).to.be.greaterThan(0));",
									"",
									"const fmtHuman = (ms) => {",
									"    if (!ms) return '‚Äî';",
									"    const d = new Date(ms);",
									"    const pad = (n) => String(n).padStart(2, '0');",
									"    return d.getFullYear() + '-' + pad(d.getMonth()+1) + '-' + pad(d.getDate()) + ' ' + pad(d.getHours()) + ':' + pad(d.getMinutes()) + ':' + pad(d.getSeconds());",
									"};",
									"const fmtAgo = (ms) => {",
									"    if (!ms) return '‚Äî';",
									"    const ago = Math.round((Date.now() - ms) / 1000);",
									"    if (ago < 0) return 'future?';",
									"    if (ago < 60) return ago + 's ago';",
									"    if (ago < 3600) return Math.round(ago/60) + 'm ago';",
									"    if (ago < 86400) return Math.round(ago/3600) + 'h ago';",
									"    return Math.round(ago/86400) + 'd ago';",
									"};",
									"",
									"let newestTs = 0;",
									"const rows = keys.sort().map(key => {",
									"    const entry = json[key] && json[key][0] ? json[key][0] : { ts: 0, value: '‚Äî' };",
									"    if (entry.ts > newestTs) newestTs = entry.ts;",
									"    return {",
									"        key: key,",
									"        value: String(entry.value).substring(0, 60),",
									"        tsRaw: entry.ts || '‚Äî',",
									"        tsHuman: fmtHuman(entry.ts),",
									"        tsAgo: fmtAgo(entry.ts)",
									"    };",
									"});",
									"",
									"const newestAge = newestTs ? Math.round((Date.now() - newestTs) / 1000) : 999999;",
									"let freshness = 'unknown';",
									"let freshnessColor = '#6b7280';",
									"if (keys.length === 0) { freshness = 'No telemetry data'; freshnessColor = '#dc2626'; }",
									"else if (newestAge < 300) { freshness = 'Actively reporting (' + fmtAgo(newestTs) + ')'; freshnessColor = '#16a34a'; }",
									"else if (newestAge < 3600) { freshness = 'Recent data (' + fmtAgo(newestTs) + ')'; freshnessColor = '#ca8a04'; }",
									"else { freshness = 'Stale ‚Äî NOT actively reporting (' + fmtAgo(newestTs) + ')'; freshnessColor = '#dc2626'; }",
									"",
									"const template = `",
									"<style>",
									"    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; }",
									"    .container { padding: 20px; max-width: 800px; }",
									"    .device-id { font-family: monospace; font-size: 12px; color: #6b7280; margin-bottom: 12px; }",
									"    .freshness { padding: 10px 14px; border-radius: 8px; margin: 12px 0; font-weight: 600; font-size: 14px; }",
									"    table { border-collapse: collapse; width: 100%; margin-top: 12px; }",
									"    th { text-align: left; padding: 8px 10px; background: #f1f5f9; border-bottom: 2px solid #e2e8f0; font-size: 12px; color: #475569; }",
									"    td { padding: 6px 10px; border-bottom: 1px solid #f1f5f9; font-size: 12px; }",
									"    .mono { font-family: monospace; }",
									"    .ts-raw { font-family: monospace; font-size: 10px; color: #9ca3af; }",
									"    .ts-ago { color: #6b7280; font-size: 11px; }",
									"</style>",
									"<div class='container'>",
									"    <h2>üì° {{deviceName}}</h2>",
									"    <div class='device-id'>ID: {{deviceId}} &nbsp;‚Ä¢&nbsp; {{keyCount}} telemetry keys</div>",
									"    <div class='freshness' style='background: {{freshnessColor}}15; color: {{freshnessColor}}'>{{freshness}}</div>",
									"    {{#if hasKeys}}",
									"    <table>",
									"        <tr><th>Key</th><th>Value</th><th>Last Updated</th><th>Age</th></tr>",
									"        {{#each rows}}",
									"        <tr>",
									"            <td class='mono'><strong>{{this.key}}</strong></td>",
									"            <td>{{this.value}}</td>",
									"            <td>{{this.tsHuman}} <span class='ts-raw'>({{this.tsRaw}})</span></td>",
									"            <td class='ts-ago'>{{this.tsAgo}}</td>",
									"        </tr>",
									"        {{/each}}",
									"    </table>",
									"    {{else}}",
									"    <p>‚ö†Ô∏è No telemetry keys. Device has never reported any data.</p>",
									"    {{/if}}",
									"</div>`;",
									"",
									"pm.visualizer.set(template, {",
									"    deviceName: name,",
									"    deviceId: id,",
									"    keyCount: keys.length,",
									"    freshness: freshness,",
									"    freshnessColor: freshnessColor,",
									"    hasKeys: keys.length > 0,",
									"    rows: rows",
									"});"
								],
								"type": "text/javascript"
							}
						}
					],
					"request": {
						"method": "GET",
						"header": [],
						"url": {
							"raw": "{{tb_url}}/api/plugins/telemetry/DEVICE/{{target_a_id}}/values/timeseries",
							"host": ["{{tb_url}}"],
							"path": ["api", "plugins", "telemetry", "DEVICE", "{{target_a_id}}", "values", "timeseries"]
						},
						"description": "# Target A ‚Äî Latest Telemetry\n\nShows the most recent value for every telemetry key.\n\nCommon DryFire keys: `event`, `totalShots`, `gameId`, `shotTime`\n\nClick **Visualize** tab for formatted table with human-readable timestamps."
					}
				},
				{
					"name": "Target B ‚Äî What is it reporting? (Telemetry)",
					"event": [
						{
							"listen": "test",
							"script": {
								"exec": [
									"const json = pm.response.json();",
									"const name = pm.collectionVariables.get('target_b_name') || 'Target B';",
									"const id = pm.collectionVariables.get('target_b_id') || '?';",
									"const keys = Object.keys(json);",
									"",
									"pm.test(name + ': ' + keys.length + ' telemetry keys', () => pm.expect(keys.length).to.be.greaterThan(0));",
									"",
									"const fmtHuman = (ms) => {",
									"    if (!ms) return '‚Äî';",
									"    const d = new Date(ms);",
									"    const pad = (n) => String(n).padStart(2, '0');",
									"    return d.getFullYear() + '-' + pad(d.getMonth()+1) + '-' + pad(d.getDate()) + ' ' + pad(d.getHours()) + ':' + pad(d.getMinutes()) + ':' + pad(d.getSeconds());",
									"};",
									"const fmtAgo = (ms) => {",
									"    if (!ms) return '‚Äî';",
									"    const ago = Math.round((Date.now() - ms) / 1000);",
									"    if (ago < 0) return 'future?';",
									"    if (ago < 60) return ago + 's ago';",
									"    if (ago < 3600) return Math.round(ago/60) + 'm ago';",
									"    if (ago < 86400) return Math.round(ago/3600) + 'h ago';",
									"    return Math.round(ago/86400) + 'd ago';",
									"};",
									"",
									"let newestTs = 0;",
									"const rows = keys.sort().map(key => {",
									"    const entry = json[key] && json[key][0] ? json[key][0] : { ts: 0, value: '‚Äî' };",
									"    if (entry.ts > newestTs) newestTs = entry.ts;",
									"    return {",
									"        key: key,",
									"        value: String(entry.value).substring(0, 60),",
									"        tsRaw: entry.ts || '‚Äî',",
									"        tsHuman: fmtHuman(entry.ts),",
									"        tsAgo: fmtAgo(entry.ts)",
									"    };",
									"});",
									"",
									"const newestAge = newestTs ? Math.round((Date.now() - newestTs) / 1000) : 999999;",
									"let freshness = 'unknown';",
									"let freshnessColor = '#6b7280';",
									"if (keys.length === 0) { freshness = 'No telemetry data'; freshnessColor = '#dc2626'; }",
									"else if (newestAge < 300) { freshness = 'Actively reporting (' + fmtAgo(newestTs) + ')'; freshnessColor = '#16a34a'; }",
									"else if (newestAge < 3600) { freshness = 'Recent data (' + fmtAgo(newestTs) + ')'; freshnessColor = '#ca8a04'; }",
									"else { freshness = 'Stale ‚Äî NOT actively reporting (' + fmtAgo(newestTs) + ')'; freshnessColor = '#dc2626'; }",
									"",
									"const template = `",
									"<style>",
									"    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; }",
									"    .container { padding: 20px; max-width: 800px; }",
									"    .device-id { font-family: monospace; font-size: 12px; color: #6b7280; margin-bottom: 12px; }",
									"    .freshness { padding: 10px 14px; border-radius: 8px; margin: 12px 0; font-weight: 600; font-size: 14px; }",
									"    table { border-collapse: collapse; width: 100%; margin-top: 12px; }",
									"    th { text-align: left; padding: 8px 10px; background: #f1f5f9; border-bottom: 2px solid #e2e8f0; font-size: 12px; color: #475569; }",
									"    td { padding: 6px 10px; border-bottom: 1px solid #f1f5f9; font-size: 12px; }",
									"    .mono { font-family: monospace; }",
									"    .ts-raw { font-family: monospace; font-size: 10px; color: #9ca3af; }",
									"    .ts-ago { color: #6b7280; font-size: 11px; }",
									"</style>",
									"<div class='container'>",
									"    <h2>üì° {{deviceName}}</h2>",
									"    <div class='device-id'>ID: {{deviceId}} &nbsp;‚Ä¢&nbsp; {{keyCount}} telemetry keys</div>",
									"    <div class='freshness' style='background: {{freshnessColor}}15; color: {{freshnessColor}}'>{{freshness}}</div>",
									"    {{#if hasKeys}}",
									"    <table>",
									"        <tr><th>Key</th><th>Value</th><th>Last Updated</th><th>Age</th></tr>",
									"        {{#each rows}}",
									"        <tr>",
									"            <td class='mono'><strong>{{this.key}}</strong></td>",
									"            <td>{{this.value}}</td>",
									"            <td>{{this.tsHuman}} <span class='ts-raw'>({{this.tsRaw}})</span></td>",
									"            <td class='ts-ago'>{{this.tsAgo}}</td>",
									"        </tr>",
									"        {{/each}}",
									"    </table>",
									"    {{else}}",
									"    <p>‚ö†Ô∏è No telemetry keys. Device has never reported any data.</p>",
									"    {{/if}}",
									"</div>`;",
									"",
									"pm.visualizer.set(template, {",
									"    deviceName: name,",
									"    deviceId: id,",
									"    keyCount: keys.length,",
									"    freshness: freshness,",
									"    freshnessColor: freshnessColor,",
									"    hasKeys: keys.length > 0,",
									"    rows: rows",
									"});"
								],
								"type": "text/javascript"
							}
						}
					],
					"request": {
						"method": "GET",
						"header": [],
						"url": {
							"raw": "{{tb_url}}/api/plugins/telemetry/DEVICE/{{target_b_id}}/values/timeseries",
							"host": ["{{tb_url}}"],
							"path": ["api", "plugins", "telemetry", "DEVICE", "{{target_b_id}}", "values", "timeseries"]
						},
						"description": "# Target B ‚Äî Latest Telemetry\n\nSame as Target A. Click **Visualize** tab for formatted output."
					}
				},
				{
					"name": "Target A ‚Äî All Attributes (server + client + shared)",
					"event": [
						{
							"listen": "test",
							"script": {
								"exec": [
									"const json = pm.response.json();",
									"const name = pm.collectionVariables.get('target_a_name') || 'Target A';",
									"const id = pm.collectionVariables.get('target_a_id') || '?';",
									"",
									"pm.test(name + ': ' + json.length + ' attributes', () => pm.expect(json.length).to.be.greaterThan(0));",
									"",
									"const fmtHuman = (ms) => {",
									"    if (!ms) return null;",
									"    if (typeof ms !== 'number' || ms < 1e11) return null;",
									"    const d = new Date(ms);",
									"    const pad = (n) => String(n).padStart(2, '0');",
									"    return d.getFullYear() + '-' + pad(d.getMonth()+1) + '-' + pad(d.getDate()) + ' ' + pad(d.getHours()) + ':' + pad(d.getMinutes()) + ':' + pad(d.getSeconds());",
									"};",
									"",
									"const gameId = json.find(a => a.key === 'gameId');",
									"const status = json.find(a => a.key === 'status');",
									"let gameState = '';",
									"if (status && status.value === 'busy') gameState = 'üéÆ Game in progress';",
									"else if (status) gameState = '‚úÖ ' + status.value;",
									"",
									"const rows = json.sort((a, b) => a.key.localeCompare(b.key)).map(attr => {",
									"    const val = attr.value;",
									"    const humanTs = fmtHuman(val);",
									"    const lastUpdate = fmtHuman(attr.lastUpdateTs);",
									"    return {",
									"        key: attr.key,",
									"        value: JSON.stringify(val),",
									"        humanTs: humanTs || '',",
									"        lastUpdate: lastUpdate || ''",
									"    };",
									"});",
									"",
									"const template = `",
									"<style>",
									"    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; }",
									"    .container { padding: 20px; max-width: 800px; }",
									"    .device-id { font-family: monospace; font-size: 12px; color: #6b7280; margin-bottom: 12px; }",
									"    .game-state { padding: 10px 14px; border-radius: 8px; margin: 12px 0; font-weight: 600; font-size: 14px; background: #f0fdf4; color: #166534; }",
									"    .game-busy { background: #fefce8; color: #854d0e; }",
									"    table { border-collapse: collapse; width: 100%; margin-top: 12px; }",
									"    th { text-align: left; padding: 8px 10px; background: #f1f5f9; border-bottom: 2px solid #e2e8f0; font-size: 12px; color: #475569; }",
									"    td { padding: 6px 10px; border-bottom: 1px solid #f1f5f9; font-size: 12px; }",
									"    .mono { font-family: monospace; font-size: 11px; }",
									"    .ts-human { color: #2563eb; font-size: 11px; }",
									"</style>",
									"<div class='container'>",
									"    <h2>üìã {{deviceName}}</h2>",
									"    <div class='device-id'>ID: {{deviceId}} &nbsp;‚Ä¢&nbsp; {{attrCount}} attributes (all scopes)</div>",
									"",
									"    {{#if gameState}}",
									"    <div class='game-state {{#if isBusy}}game-busy{{/if}}'>{{gameState}}{{#if gameIdValue}} &nbsp;‚Ä¢&nbsp; gameId: {{gameIdValue}}{{/if}}</div>",
									"    {{/if}}",
									"",
									"    <table>",
									"        <tr><th>Key</th><th>Value</th><th>Timestamp (if applicable)</th><th>Last Updated</th></tr>",
									"        {{#each rows}}",
									"        <tr>",
									"            <td class='mono'><strong>{{this.key}}</strong></td>",
									"            <td>{{this.value}}</td>",
									"            <td class='ts-human'>{{this.humanTs}}</td>",
									"            <td class='ts-human'>{{this.lastUpdate}}</td>",
									"        </tr>",
									"        {{/each}}",
									"    </table>",
									"</div>`;",
									"",
									"pm.visualizer.set(template, {",
									"    deviceName: name,",
									"    deviceId: id,",
									"    attrCount: json.length,",
									"    gameState: gameState,",
									"    isBusy: status && status.value === 'busy',",
									"    gameIdValue: gameId ? gameId.value : '',",
									"    rows: rows",
									"});"
								],
								"type": "text/javascript"
							}
						}
					],
					"request": {
						"method": "GET",
						"header": [],
						"url": {
							"raw": "{{tb_url}}/api/plugins/telemetry/DEVICE/{{target_a_id}}/values/attributes",
							"host": ["{{tb_url}}"],
							"path": ["api", "plugins", "telemetry", "DEVICE", "{{target_a_id}}", "values", "attributes"]
						},
						"description": "# Target A ‚Äî All Attributes\n\nReturns every attribute across all scopes (SERVER, CLIENT, SHARED).\n\nKey ones:\n- `active` (server) ‚Äî is MQTT connected?\n- `status` (shared) ‚Äî `busy` or `free`\n- `gameId` (shared) ‚Äî current game session\n- `desiredDurationSeconds` (shared) ‚Äî game length\n\nClick **Visualize** tab for formatted table. Timestamp values are auto-converted to human-readable dates."
					}
				},
				{
					"name": "Target B ‚Äî All Attributes (server + client + shared)",
					"event": [
						{
							"listen": "test",
							"script": {
								"exec": [
									"const json = pm.response.json();",
									"const name = pm.collectionVariables.get('target_b_name') || 'Target B';",
									"const id = pm.collectionVariables.get('target_b_id') || '?';",
									"",
									"pm.test(name + ': ' + json.length + ' attributes', () => pm.expect(json.length).to.be.greaterThan(0));",
									"",
									"const fmtHuman = (ms) => {",
									"    if (!ms) return null;",
									"    if (typeof ms !== 'number' || ms < 1e11) return null;",
									"    const d = new Date(ms);",
									"    const pad = (n) => String(n).padStart(2, '0');",
									"    return d.getFullYear() + '-' + pad(d.getMonth()+1) + '-' + pad(d.getDate()) + ' ' + pad(d.getHours()) + ':' + pad(d.getMinutes()) + ':' + pad(d.getSeconds());",
									"};",
									"",
									"const gameId = json.find(a => a.key === 'gameId');",
									"const status = json.find(a => a.key === 'status');",
									"let gameState = '';",
									"if (status && status.value === 'busy') gameState = 'üéÆ Game in progress';",
									"else if (status) gameState = '‚úÖ ' + status.value;",
									"",
									"const rows = json.sort((a, b) => a.key.localeCompare(b.key)).map(attr => {",
									"    const val = attr.value;",
									"    const humanTs = fmtHuman(val);",
									"    const lastUpdate = fmtHuman(attr.lastUpdateTs);",
									"    return {",
									"        key: attr.key,",
									"        value: JSON.stringify(val),",
									"        humanTs: humanTs || '',",
									"        lastUpdate: lastUpdate || ''",
									"    };",
									"});",
									"",
									"const template = `",
									"<style>",
									"    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; }",
									"    .container { padding: 20px; max-width: 800px; }",
									"    .device-id { font-family: monospace; font-size: 12px; color: #6b7280; margin-bottom: 12px; }",
									"    .game-state { padding: 10px 14px; border-radius: 8px; margin: 12px 0; font-weight: 600; font-size: 14px; background: #f0fdf4; color: #166534; }",
									"    .game-busy { background: #fefce8; color: #854d0e; }",
									"    table { border-collapse: collapse; width: 100%; margin-top: 12px; }",
									"    th { text-align: left; padding: 8px 10px; background: #f1f5f9; border-bottom: 2px solid #e2e8f0; font-size: 12px; color: #475569; }",
									"    td { padding: 6px 10px; border-bottom: 1px solid #f1f5f9; font-size: 12px; }",
									"    .mono { font-family: monospace; font-size: 11px; }",
									"    .ts-human { color: #2563eb; font-size: 11px; }",
									"</style>",
									"<div class='container'>",
									"    <h2>üìã {{deviceName}}</h2>",
									"    <div class='device-id'>ID: {{deviceId}} &nbsp;‚Ä¢&nbsp; {{attrCount}} attributes (all scopes)</div>",
									"",
									"    {{#if gameState}}",
									"    <div class='game-state {{#if isBusy}}game-busy{{/if}}'>{{gameState}}{{#if gameIdValue}} &nbsp;‚Ä¢&nbsp; gameId: {{gameIdValue}}{{/if}}</div>",
									"    {{/if}}",
									"",
									"    <table>",
									"        <tr><th>Key</th><th>Value</th><th>Timestamp (if applicable)</th><th>Last Updated</th></tr>",
									"        {{#each rows}}",
									"        <tr>",
									"            <td class='mono'><strong>{{this.key}}</strong></td>",
									"            <td>{{this.value}}</td>",
									"            <td class='ts-human'>{{this.humanTs}}</td>",
									"            <td class='ts-human'>{{this.lastUpdate}}</td>",
									"        </tr>",
									"        {{/each}}",
									"    </table>",
									"</div>`;",
									"",
									"pm.visualizer.set(template, {",
									"    deviceName: name,",
									"    deviceId: id,",
									"    attrCount: json.length,",
									"    gameState: gameState,",
									"    isBusy: status && status.value === 'busy',",
									"    gameIdValue: gameId ? gameId.value : '',",
									"    rows: rows",
									"});"
								],
								"type": "text/javascript"
							}
						}
					],
					"request": {
						"method": "GET",
						"header": [],
						"url": {
							"raw": "{{tb_url}}/api/plugins/telemetry/DEVICE/{{target_b_id}}/values/attributes",
							"host": ["{{tb_url}}"],
							"path": ["api", "plugins", "telemetry", "DEVICE", "{{target_b_id}}", "values", "attributes"]
						},
						"description": "# Target B ‚Äî All Attributes\n\nSame as Target A. Click **Visualize** tab."
					}
				}
			]
		},
		{
			"name": "2. Game Flow ‚Äî Start ‚Üí Play ‚Üí Stop",
			"description": "# Game Flow\n\nReplicates the exact sequence the Glow dashboard performs when a user starts a game.\n\n## Prerequisites\n- Run **Setup** folder first (Login + Discover)\n- Both targets should show `active: true` in Health Check\n\n## Run order\n| Step | Request | What it does |\n|---|---|---|\n| 1 | Prepare Target A | Write shared attrs (gameId, busy) |\n| 2 | Prepare Target B | Same |\n| 3 | Start Target A | Send RPC \"start\" |\n| 4 | Start Target B | Send RPC \"start\" |\n| ‚Äî | **WAIT 30s** | Game plays |\n| 5 | Stop Target A | Send RPC \"stop\" |\n| 6 | Stop Target B | Send RPC \"stop\" |\n| 7 | Cleanup Target A | Reset to \"free\" |\n| 8 | Cleanup Target B | Reset to \"free\" |\n\n## ‚ö†Ô∏è If devices are offline\nRPC requests (3-6) will **hang for 30+ seconds** or return 504.\nCheck Health Check first!\n\n## Reading results\nClick the **Visualize** tab after each request for formatted output.",
			"item": [
				{
					"name": "1. Prepare ‚Äî Write game attrs to Target A",
					"event": [
						{
							"listen": "prerequest",
							"script": {
								"exec": [
									"const gameId = 'GM-POSTMAN-' + Date.now();",
									"pm.collectionVariables.set('game_id', gameId);"
								],
								"type": "text/javascript"
							}
						},
						{
							"listen": "test",
							"script": {
								"exec": [
									"const name = pm.collectionVariables.get('target_a_name') || 'Target A';",
									"const id = pm.collectionVariables.get('target_a_id') || '?';",
									"const gameId = pm.collectionVariables.get('game_id');",
									"const duration = pm.collectionVariables.get('game_duration');",
									"const ok = pm.response.code === 200;",
									"",
									"pm.test(ok ? '‚úÖ ' + name + ': game attrs written' : '‚ùå Failed: HTTP ' + pm.response.code,",
									"    () => pm.expect(pm.response.code).to.equal(200));",
									"",
									"const template = `",
									"<div style='font-family:-apple-system,BlinkMacSystemFont,sans-serif;padding:20px;max-width:600px'>",
									"    <h2>{{#if ok}}‚úÖ{{else}}‚ùå{{/if}} Prepare ‚Äî {{deviceName}}</h2>",
									"    <div style='font-family:monospace;font-size:12px;color:#6b7280;margin-bottom:12px'>ID: {{deviceId}}</div>",
									"    {{#if ok}}",
									"    <table style='border-collapse:collapse;width:100%'>",
									"        <tr><td style='padding:8px;font-weight:bold;color:#6b7280;width:200px'>gameId</td><td style='padding:8px;font-family:monospace'>{{gameId}}</td></tr>",
									"        <tr style='background:#f9fafb'><td style='padding:8px;font-weight:bold;color:#6b7280'>status</td><td style='padding:8px'>busy</td></tr>",
									"        <tr><td style='padding:8px;font-weight:bold;color:#6b7280'>desiredDurationSeconds</td><td style='padding:8px'>{{duration}}</td></tr>",
									"    </table>",
									"    <p style='margin-top:16px;padding:12px;background:#f0fdf4;border-radius:8px;color:#166534'>",
									"        üëâ <strong>NEXT:</strong> Run same for Target B",
									"    </p>",
									"    {{else}}",
									"    <p style='padding:12px;background:#fef2f2;border-radius:8px;color:#991b1b'>",
									"        HTTP {{httpCode}} ‚Äî shared attributes were not written",
									"    </p>",
									"    {{/if}}",
									"</div>`;",
									"",
									"pm.visualizer.set(template, {",
									"    ok: ok,",
									"    deviceName: name,",
									"    deviceId: id,",
									"    gameId: gameId,",
									"    duration: duration,",
									"    httpCode: pm.response.code",
									"});"
								],
								"type": "text/javascript"
							}
						}
					],
					"request": {
						"method": "POST",
						"header": [
							{ "key": "Content-Type", "value": "application/json" }
						],
						"body": {
							"mode": "raw",
							"raw": "{\n    \"gameId\": \"{{game_id}}\",\n    \"status\": \"busy\",\n    \"desiredDurationSeconds\": {{game_duration}}\n}"
						},
						"url": {
							"raw": "{{tb_url}}/api/plugins/telemetry/DEVICE/{{target_a_id}}/SHARED_SCOPE",
							"host": ["{{tb_url}}"],
							"path": ["api", "plugins", "telemetry", "DEVICE", "{{target_a_id}}", "SHARED_SCOPE"]
						},
						"description": "# Prepare ‚Äî Target A\n\nWrites shared attributes to signal a game is starting. A unique `game_id` is auto-generated.\n\nClick **Visualize** tab for formatted confirmation."
					}
				},
				{
					"name": "2. Prepare ‚Äî Write game attrs to Target B",
					"event": [
						{
							"listen": "test",
							"script": {
								"exec": [
									"const name = pm.collectionVariables.get('target_b_name') || 'Target B';",
									"const id = pm.collectionVariables.get('target_b_id') || '?';",
									"const gameId = pm.collectionVariables.get('game_id');",
									"const duration = pm.collectionVariables.get('game_duration');",
									"const ok = pm.response.code === 200;",
									"",
									"pm.test(ok ? '‚úÖ ' + name + ': game attrs written' : '‚ùå Failed: HTTP ' + pm.response.code,",
									"    () => pm.expect(pm.response.code).to.equal(200));",
									"",
									"const template = `",
									"<div style='font-family:-apple-system,BlinkMacSystemFont,sans-serif;padding:20px;max-width:600px'>",
									"    <h2>{{#if ok}}‚úÖ{{else}}‚ùå{{/if}} Prepare ‚Äî {{deviceName}}</h2>",
									"    <div style='font-family:monospace;font-size:12px;color:#6b7280;margin-bottom:12px'>ID: {{deviceId}}</div>",
									"    {{#if ok}}",
									"    <table style='border-collapse:collapse;width:100%'>",
									"        <tr><td style='padding:8px;font-weight:bold;color:#6b7280;width:200px'>gameId</td><td style='padding:8px;font-family:monospace'>{{gameId}}</td></tr>",
									"        <tr style='background:#f9fafb'><td style='padding:8px;font-weight:bold;color:#6b7280'>status</td><td style='padding:8px'>busy</td></tr>",
									"        <tr><td style='padding:8px;font-weight:bold;color:#6b7280'>desiredDurationSeconds</td><td style='padding:8px'>{{duration}}</td></tr>",
									"    </table>",
									"    <p style='margin-top:16px;padding:12px;background:#f0fdf4;border-radius:8px;color:#166534'>",
									"        üëâ <strong>NEXT:</strong> Send RPC \"start\" to both targets",
									"    </p>",
									"    {{else}}",
									"    <p style='padding:12px;background:#fef2f2;border-radius:8px;color:#991b1b'>",
									"        HTTP {{httpCode}} ‚Äî shared attributes were not written",
									"    </p>",
									"    {{/if}}",
									"</div>`;",
									"",
									"pm.visualizer.set(template, {",
									"    ok: ok,",
									"    deviceName: name,",
									"    deviceId: id,",
									"    gameId: gameId,",
									"    duration: duration,",
									"    httpCode: pm.response.code",
									"});"
								],
								"type": "text/javascript"
							}
						}
					],
					"request": {
						"method": "POST",
						"header": [
							{ "key": "Content-Type", "value": "application/json" }
						],
						"body": {
							"mode": "raw",
							"raw": "{\n    \"gameId\": \"{{game_id}}\",\n    \"status\": \"busy\",\n    \"desiredDurationSeconds\": {{game_duration}}\n}"
						},
						"url": {
							"raw": "{{tb_url}}/api/plugins/telemetry/DEVICE/{{target_b_id}}/SHARED_SCOPE",
							"host": ["{{tb_url}}"],
							"path": ["api", "plugins", "telemetry", "DEVICE", "{{target_b_id}}", "SHARED_SCOPE"]
						},
						"description": "# Prepare ‚Äî Target B\n\nSame as Target A. Click **Visualize** tab."
					}
				},
				{
					"name": "3. Send RPC \"start\" ‚Üí Target A ‚ö†Ô∏è may hang if offline",
					"event": [
						{
							"listen": "prerequest",
							"script": {
								"exec": [
									"pm.collectionVariables.set('_rpc_t0', Date.now().toString());"
								],
								"type": "text/javascript"
							}
						},
						{
							"listen": "test",
							"script": {
								"exec": [
									"const name = pm.collectionVariables.get('target_a_name') || 'Target A';",
									"const id = pm.collectionVariables.get('target_a_id') || '?';",
									"const elapsed = Date.now() - parseInt(pm.collectionVariables.get('_rpc_t0') || '0');",
									"const code = pm.response.code;",
									"",
									"if (code === 200) {",
									"    pm.test('‚úÖ RPC start ‚Üí ' + name + ' (' + elapsed + 'ms)', () => pm.expect(true).to.be.true);",
									"} else {",
									"    pm.test('‚ùå RPC failed: HTTP ' + code, () => pm.expect(code).to.equal(200));",
									"}",
									"",
									"const template = `",
									"<div style='font-family:-apple-system,BlinkMacSystemFont,sans-serif;padding:20px;max-width:600px'>",
									"    <h2>üöÄ RPC \"start\" ‚Üí {{deviceName}}</h2>",
									"    <div style='font-family:monospace;font-size:12px;color:#6b7280;margin-bottom:12px'>ID: {{deviceId}}</div>",
									"    {{#if delivered}}",
									"    <div style='padding:16px;background:#f0fdf4;border:1px solid #bbf7d0;border-radius:8px;margin:12px 0'>",
									"        <strong style='color:#166534'>‚úÖ DELIVERED</strong> in {{elapsed}}ms",
									"        <p style='color:#15803d;margin:8px 0 0 0'>Device received the start command via MQTT. It should now be active.</p>",
									"    </div>",
									"    <p style='padding:12px;background:#eff6ff;border-radius:8px;color:#1e40af'>",
									"        üëâ <strong>NEXT:</strong> Send start to Target B",
									"    </p>",
									"    {{else if timedOut}}",
									"    <div style='padding:16px;background:#fef2f2;border:1px solid #fecaca;border-radius:8px;margin:12px 0'>",
									"        <strong style='color:#991b1b'>‚ùå 504 GATEWAY TIMEOUT</strong> ({{elapsed}}ms)",
									"        <p style='color:#b91c1c;margin:8px 0 0 0'>ThingsBoard could not reach the device ‚Äî no active MQTT session.</p>",
									"    </div>",
									"    <div style='padding:10px;background:#fef2f2;border-radius:6px;color:#991b1b;font-size:13px;margin-top:8px'>",
									"        üí° <strong>Fix:</strong> Power-cycle device, wait 60s, re-check MQTT status in Health Check",
									"    </div>",
									"    {{else}}",
									"    <div style='padding:16px;background:#fefce8;border:1px solid #fde68a;border-radius:8px;margin:12px 0'>",
									"        <strong style='color:#854d0e'>‚ö†Ô∏è HTTP {{httpCode}}</strong> ({{elapsed}}ms)",
									"    </div>",
									"    {{/if}}",
									"</div>`;",
									"",
									"pm.visualizer.set(template, {",
									"    deviceName: name,",
									"    deviceId: id,",
									"    elapsed: elapsed,",
									"    httpCode: code,",
									"    delivered: code === 200,",
									"    timedOut: code === 504",
									"});"
								],
								"type": "text/javascript"
							}
						}
					],
					"request": {
						"method": "POST",
						"header": [
							{ "key": "Content-Type", "value": "application/json" }
						],
						"body": {
							"mode": "raw",
							"raw": "{\n    \"method\": \"start\",\n    \"params\": {\n        \"ts\": {{$timestamp}}000,\n        \"values\": {\n            \"deviceId\": \"{{target_a_id}}\",\n            \"event\": \"start\",\n            \"gameId\": \"{{game_id}}\",\n            \"desiredDurationSeconds\": {{game_duration}}\n        }\n    }\n}"
						},
						"url": {
							"raw": "{{tb_url}}/api/rpc/oneway/{{target_a_id}}",
							"host": ["{{tb_url}}"],
							"path": ["api", "rpc", "oneway", "{{target_a_id}}"]
						},
						"description": "# RPC \"start\" ‚Üí Target A\n\nSends one-way RPC via ThingsBoard ‚Üí MQTT ‚Üí device.\n\n| Response | Meaning |\n|---|---|\n| 200 | ‚úÖ Delivered to device |\n| 504 | ‚ùå Device offline |\n| Timeout | ‚ùå TB waiting for reconnect |\n\n‚ö†Ô∏è **If offline, this hangs 30+ seconds.** Set Postman timeout: Settings ‚Üí General ‚Üí Request timeout = 30000ms\n\nClick **Visualize** tab for formatted result."
					}
				},
				{
					"name": "4. Send RPC \"start\" ‚Üí Target B ‚ö†Ô∏è may hang if offline",
					"event": [
						{
							"listen": "prerequest",
							"script": {
								"exec": [
									"pm.collectionVariables.set('_rpc_t0', Date.now().toString());"
								],
								"type": "text/javascript"
							}
						},
						{
							"listen": "test",
							"script": {
								"exec": [
									"const name = pm.collectionVariables.get('target_b_name') || 'Target B';",
									"const id = pm.collectionVariables.get('target_b_id') || '?';",
									"const elapsed = Date.now() - parseInt(pm.collectionVariables.get('_rpc_t0') || '0');",
									"const code = pm.response.code;",
									"const duration = pm.collectionVariables.get('game_duration');",
									"",
									"if (code === 200) {",
									"    pm.test('‚úÖ RPC start ‚Üí ' + name + ' (' + elapsed + 'ms)', () => pm.expect(true).to.be.true);",
									"} else {",
									"    pm.test('‚ùå RPC failed: HTTP ' + code, () => pm.expect(code).to.equal(200));",
									"}",
									"",
									"const template = `",
									"<div style='font-family:-apple-system,BlinkMacSystemFont,sans-serif;padding:20px;max-width:600px'>",
									"    <h2>üöÄ RPC \"start\" ‚Üí {{deviceName}}</h2>",
									"    <div style='font-family:monospace;font-size:12px;color:#6b7280;margin-bottom:12px'>ID: {{deviceId}}</div>",
									"    {{#if delivered}}",
									"    <div style='padding:16px;background:#f0fdf4;border:1px solid #bbf7d0;border-radius:8px;margin:12px 0'>",
									"        <strong style='color:#166534'>‚úÖ DELIVERED</strong> in {{elapsed}}ms",
									"        <p style='color:#15803d;margin:8px 0 0 0'>üéÆ Game is now running on both targets!</p>",
									"    </div>",
									"    <p style='padding:12px;background:#fefce8;border-radius:8px;color:#854d0e'>",
									"        ‚è±Ô∏è Wait <strong>{{duration}} seconds</strong>, then run the \"stop\" requests",
									"    </p>",
									"    {{else if timedOut}}",
									"    <div style='padding:16px;background:#fef2f2;border:1px solid #fecaca;border-radius:8px;margin:12px 0'>",
									"        <strong style='color:#991b1b'>‚ùå 504 GATEWAY TIMEOUT</strong> ({{elapsed}}ms)",
									"        <p style='color:#b91c1c;margin:8px 0 0 0'>Device offline.</p>",
									"    </div>",
									"    {{else}}",
									"    <div style='padding:16px;background:#fefce8;border:1px solid #fde68a;border-radius:8px;margin:12px 0'>",
									"        <strong style='color:#854d0e'>‚ö†Ô∏è HTTP {{httpCode}}</strong> ({{elapsed}}ms)",
									"    </div>",
									"    {{/if}}",
									"</div>`;",
									"",
									"pm.visualizer.set(template, {",
									"    deviceName: name,",
									"    deviceId: id,",
									"    elapsed: elapsed,",
									"    httpCode: code,",
									"    delivered: code === 200,",
									"    timedOut: code === 504,",
									"    duration: duration",
									"});"
								],
								"type": "text/javascript"
							}
						}
					],
					"request": {
						"method": "POST",
						"header": [
							{ "key": "Content-Type", "value": "application/json" }
						],
						"body": {
							"mode": "raw",
							"raw": "{\n    \"method\": \"start\",\n    \"params\": {\n        \"ts\": {{$timestamp}}000,\n        \"values\": {\n            \"deviceId\": \"{{target_b_id}}\",\n            \"event\": \"start\",\n            \"gameId\": \"{{game_id}}\",\n            \"desiredDurationSeconds\": {{game_duration}}\n        }\n    }\n}"
						},
						"url": {
							"raw": "{{tb_url}}/api/rpc/oneway/{{target_b_id}}",
							"host": ["{{tb_url}}"],
							"path": ["api", "rpc", "oneway", "{{target_b_id}}"]
						},
						"description": "# RPC \"start\" ‚Üí Target B\n\nAfter this, both targets should be in game mode. Click **Visualize** tab."
					}
				},
				{
					"name": "‚îÄ‚îÄ ‚è±Ô∏è WAIT ‚Äî Game is playing for {{game_duration}}s ‚îÄ‚îÄ",
					"event": [
						{
							"listen": "test",
							"script": {
								"exec": [
									"const duration = pm.collectionVariables.get('game_duration');",
									"const template = `",
									"<div style='font-family:-apple-system,BlinkMacSystemFont,sans-serif;padding:40px;text-align:center;max-width:500px;margin:0 auto'>",
									"    <h1 style='font-size:48px;margin:0'>‚è±Ô∏è</h1>",
									"    <h2>Game is Playing</h2>",
									"    <p style='color:#6b7280;font-size:16px'>Wait <strong>{{duration}} seconds</strong> for the game to complete.</p>",
									"    <p style='color:#6b7280;font-size:14px'>If devices are online, they should be active now (lights/sound/hit detection).</p>",
									"    <div style='margin-top:24px;padding:12px;background:#f0fdf4;border-radius:8px;color:#166534'>",
									"        üëâ When ready, run the <strong>\"stop\"</strong> requests below",
									"    </div>",
									"</div>`;",
									"pm.visualizer.set(template, { duration: duration });"
								],
								"type": "text/javascript"
							}
						}
					],
					"request": {
						"method": "GET",
						"header": [],
						"url": {
							"raw": "{{tb_url}}/api/auth/user",
							"host": ["{{tb_url}}"],
							"path": ["api", "auth", "user"]
						},
						"description": "# ‚è±Ô∏è PAUSE ‚Äî Wait for the game to play\n\n**Wait {{game_duration}} seconds** before sending \"stop\".\n\nThis is just a placeholder ‚Äî it fetches your user info as a keep-alive."
					}
				},
				{
					"name": "5. Send RPC \"stop\" ‚Üí Target A",
					"event": [
						{
							"listen": "prerequest",
							"script": {
								"exec": [
									"pm.collectionVariables.set('_rpc_t0', Date.now().toString());"
								],
								"type": "text/javascript"
							}
						},
						{
							"listen": "test",
							"script": {
								"exec": [
									"const name = pm.collectionVariables.get('target_a_name') || 'Target A';",
									"const id = pm.collectionVariables.get('target_a_id') || '?';",
									"const elapsed = Date.now() - parseInt(pm.collectionVariables.get('_rpc_t0') || '0');",
									"const code = pm.response.code;",
									"",
									"pm.test(code === 200 ? '‚úÖ RPC stop ‚Üí ' + name : '‚ùå Failed',",
									"    () => pm.expect(code).to.equal(200));",
									"",
									"const template = `",
									"<div style='font-family:-apple-system,BlinkMacSystemFont,sans-serif;padding:20px;max-width:600px'>",
									"    <h2>üõë RPC \"stop\" ‚Üí {{deviceName}}</h2>",
									"    <div style='font-family:monospace;font-size:12px;color:#6b7280;margin-bottom:12px'>ID: {{deviceId}}</div>",
									"    {{#if ok}}",
									"    <div style='padding:16px;background:#f0fdf4;border:1px solid #bbf7d0;border-radius:8px'>",
									"        <strong style='color:#166534'>‚úÖ Stopped</strong> in {{elapsed}}ms",
									"    </div>",
									"    {{else}}",
									"    <div style='padding:16px;background:#fef2f2;border:1px solid #fecaca;border-radius:8px'>",
									"        <strong style='color:#991b1b'>‚ùå HTTP {{httpCode}}</strong> ({{elapsed}}ms)",
									"    </div>",
									"    {{/if}}",
									"</div>`;",
									"",
									"pm.visualizer.set(template, {",
									"    deviceName: name,",
									"    deviceId: id,",
									"    elapsed: elapsed,",
									"    httpCode: code,",
									"    ok: code === 200",
									"});"
								],
								"type": "text/javascript"
							}
						}
					],
					"request": {
						"method": "POST",
						"header": [
							{ "key": "Content-Type", "value": "application/json" }
						],
						"body": {
							"mode": "raw",
							"raw": "{\n    \"method\": \"stop\",\n    \"params\": {\n        \"ts\": {{$timestamp}}000,\n        \"values\": {\n            \"deviceId\": \"{{target_a_id}}\",\n            \"event\": \"stop\",\n            \"gameId\": \"{{game_id}}\",\n            \"desiredDurationSeconds\": {{game_duration}}\n        }\n    }\n}"
						},
						"url": {
							"raw": "{{tb_url}}/api/rpc/oneway/{{target_a_id}}",
							"host": ["{{tb_url}}"],
							"path": ["api", "rpc", "oneway", "{{target_a_id}}"]
						},
						"description": "# RPC \"stop\" ‚Üí Target A\n\nEnds the game. Click **Visualize** tab."
					}
				},
				{
					"name": "6. Send RPC \"stop\" ‚Üí Target B",
					"event": [
						{
							"listen": "prerequest",
							"script": {
								"exec": [
									"pm.collectionVariables.set('_rpc_t0', Date.now().toString());"
								],
								"type": "text/javascript"
							}
						},
						{
							"listen": "test",
							"script": {
								"exec": [
									"const name = pm.collectionVariables.get('target_b_name') || 'Target B';",
									"const id = pm.collectionVariables.get('target_b_id') || '?';",
									"const elapsed = Date.now() - parseInt(pm.collectionVariables.get('_rpc_t0') || '0');",
									"const code = pm.response.code;",
									"",
									"pm.test(code === 200 ? '‚úÖ RPC stop ‚Üí ' + name : '‚ùå Failed',",
									"    () => pm.expect(code).to.equal(200));",
									"",
									"const template = `",
									"<div style='font-family:-apple-system,BlinkMacSystemFont,sans-serif;padding:20px;max-width:600px'>",
									"    <h2>üõë RPC \"stop\" ‚Üí {{deviceName}}</h2>",
									"    <div style='font-family:monospace;font-size:12px;color:#6b7280;margin-bottom:12px'>ID: {{deviceId}}</div>",
									"    {{#if ok}}",
									"    <div style='padding:16px;background:#f0fdf4;border:1px solid #bbf7d0;border-radius:8px'>",
									"        <strong style='color:#166534'>‚úÖ Stopped</strong> in {{elapsed}}ms",
									"        <p style='color:#15803d;margin:8px 0 0 0'>Both targets stopped. Now reset shared attrs to \"free\".</p>",
									"    </div>",
									"    {{else}}",
									"    <div style='padding:16px;background:#fef2f2;border:1px solid #fecaca;border-radius:8px'>",
									"        <strong style='color:#991b1b'>‚ùå HTTP {{httpCode}}</strong> ({{elapsed}}ms)",
									"    </div>",
									"    {{/if}}",
									"</div>`;",
									"",
									"pm.visualizer.set(template, {",
									"    deviceName: name,",
									"    deviceId: id,",
									"    elapsed: elapsed,",
									"    httpCode: code,",
									"    ok: code === 200",
									"});"
								],
								"type": "text/javascript"
							}
						}
					],
					"request": {
						"method": "POST",
						"header": [
							{ "key": "Content-Type", "value": "application/json" }
						],
						"body": {
							"mode": "raw",
							"raw": "{\n    \"method\": \"stop\",\n    \"params\": {\n        \"ts\": {{$timestamp}}000,\n        \"values\": {\n            \"deviceId\": \"{{target_b_id}}\",\n            \"event\": \"stop\",\n            \"gameId\": \"{{game_id}}\",\n            \"desiredDurationSeconds\": {{game_duration}}\n        }\n    }\n}"
						},
						"url": {
							"raw": "{{tb_url}}/api/rpc/oneway/{{target_b_id}}",
							"host": ["{{tb_url}}"],
							"path": ["api", "rpc", "oneway", "{{target_b_id}}"]
						},
						"description": "# RPC \"stop\" ‚Üí Target B\n\nClick **Visualize** tab."
					}
				},
				{
					"name": "7. Cleanup ‚Äî Reset Target A to \"free\"",
					"event": [
						{
							"listen": "test",
							"script": {
								"exec": [
									"const name = pm.collectionVariables.get('target_a_name') || 'Target A';",
									"const id = pm.collectionVariables.get('target_a_id') || '?';",
									"const ok = pm.response.code === 200;",
									"",
									"pm.test(ok ? '‚úÖ ' + name + ': status = free' : '‚ùå Failed',",
									"    () => pm.expect(pm.response.code).to.equal(200));",
									"",
									"const template = `",
									"<div style='font-family:-apple-system,BlinkMacSystemFont,sans-serif;padding:20px;max-width:600px'>",
									"    <h2>üßπ Cleanup ‚Äî {{deviceName}}</h2>",
									"    <div style='font-family:monospace;font-size:12px;color:#6b7280;margin-bottom:12px'>ID: {{deviceId}}</div>",
									"    {{#if ok}}",
									"    <div style='padding:16px;background:#f0fdf4;border:1px solid #bbf7d0;border-radius:8px'>",
									"        <strong style='color:#166534'>‚úÖ Reset to status = free</strong>",
									"    </div>",
									"    {{else}}",
									"    <div style='padding:16px;background:#fef2f2;border:1px solid #fecaca;border-radius:8px'>",
									"        <strong style='color:#991b1b'>‚ùå HTTP {{httpCode}}</strong>",
									"    </div>",
									"    {{/if}}",
									"</div>`;",
									"",
									"pm.visualizer.set(template, {",
									"    deviceName: name,",
									"    deviceId: id,",
									"    ok: ok,",
									"    httpCode: pm.response.code",
									"});"
								],
								"type": "text/javascript"
							}
						}
					],
					"request": {
						"method": "POST",
						"header": [
							{ "key": "Content-Type", "value": "application/json" }
						],
						"body": {
							"mode": "raw",
							"raw": "{\n    \"status\": \"free\",\n    \"gameId\": \"{{game_id}}\"\n}"
						},
						"url": {
							"raw": "{{tb_url}}/api/plugins/telemetry/DEVICE/{{target_a_id}}/SHARED_SCOPE",
							"host": ["{{tb_url}}"],
							"path": ["api", "plugins", "telemetry", "DEVICE", "{{target_a_id}}", "SHARED_SCOPE"]
						},
						"description": "# Cleanup ‚Äî Target A\n\nResets `status` to `free`. Click **Visualize** tab."
					}
				},
				{
					"name": "8. Cleanup ‚Äî Reset Target B to \"free\"",
					"event": [
						{
							"listen": "test",
							"script": {
								"exec": [
									"const name = pm.collectionVariables.get('target_b_name') || 'Target B';",
									"const id = pm.collectionVariables.get('target_b_id') || '?';",
									"const ok = pm.response.code === 200;",
									"",
									"pm.test(ok ? '‚úÖ ' + name + ': status = free' : '‚ùå Failed',",
									"    () => pm.expect(pm.response.code).to.equal(200));",
									"",
									"const template = `",
									"<div style='font-family:-apple-system,BlinkMacSystemFont,sans-serif;padding:20px;max-width:600px'>",
									"    <h2>üßπ Cleanup ‚Äî {{deviceName}}</h2>",
									"    <div style='font-family:monospace;font-size:12px;color:#6b7280;margin-bottom:12px'>ID: {{deviceId}}</div>",
									"    {{#if ok}}",
									"    <div style='padding:16px;background:#f0fdf4;border:1px solid #bbf7d0;border-radius:8px'>",
									"        <strong style='color:#166534'>‚úÖ Reset to status = free</strong>",
									"    </div>",
									"    <div style='margin-top:20px;padding:16px;background:#eff6ff;border:1px solid #bfdbfe;border-radius:8px;text-align:center'>",
									"        <h3 style='color:#1e40af;margin:0 0 8px 0'>üèÅ GAME FLOW COMPLETE</h3>",
									"        <p style='color:#3b82f6;margin:0'>Go to \"1. Device Health Check\" ‚Üí Telemetry to see if devices reported hits</p>",
									"    </div>",
									"    {{else}}",
									"    <div style='padding:16px;background:#fef2f2;border:1px solid #fecaca;border-radius:8px'>",
									"        <strong style='color:#991b1b'>‚ùå HTTP {{httpCode}}</strong>",
									"    </div>",
									"    {{/if}}",
									"</div>`;",
									"",
									"pm.visualizer.set(template, {",
									"    deviceName: name,",
									"    deviceId: id,",
									"    ok: ok,",
									"    httpCode: pm.response.code",
									"});"
								],
								"type": "text/javascript"
							}
						}
					],
					"request": {
						"method": "POST",
						"header": [
							{ "key": "Content-Type", "value": "application/json" }
						],
						"body": {
							"mode": "raw",
							"raw": "{\n    \"status\": \"free\",\n    \"gameId\": \"{{game_id}}\"\n}"
						},
						"url": {
							"raw": "{{tb_url}}/api/plugins/telemetry/DEVICE/{{target_b_id}}/SHARED_SCOPE",
							"host": ["{{tb_url}}"],
							"path": ["api", "plugins", "telemetry", "DEVICE", "{{target_b_id}}", "SHARED_SCOPE"]
						},
						"description": "# Cleanup ‚Äî Target B\n\nBoth targets are now `free`. Game flow complete. Click **Visualize** tab."
					}
				}
			]
		}
	]
}